name: Deploy to VPS

on:
  push:
    branches:
      - main
    tags:
      - '*'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            set -e
            cd /opt/static-website
            echo "Current directory: $(pwd)"
            echo "Deploying ref: ${{ github.ref_name }}"

            git fetch --all --tags

            # Save a backup of the current .env in case we need to recover secrets
            if [ -f .env ]; then
              cp .env .env.bak
              echo "Backup of .env created as .env.bak"
            fi

            # Clean any previous failed states
            git merge --abort || true
            git reset --hard HEAD

            # Pull latest changes
            if [[ "${{ github.ref }}" == refs/tags/* ]]; then
              echo "Deploying tag: ${{ github.ref_name }}"
              git checkout ${{ github.ref_name }}
            else
              echo "Deploying branch: ${{ github.ref_name }}"
              git checkout main
              git pull origin main
            fi

            # Create/Overwrite .env from GitHub Secrets
            echo "Generating .env from GitHub Secrets..."
            printf "VITE_N8N_WEBHOOK_URL=%s\nVITE_SUPABASE_URL=%s\nVITE_SUPABASE_ANON_KEY=%s\nDOMAIN_NAME=%s\nSUBDOMAIN=%s\nCHICHA_SUBDOMAIN=%s\n" \
              "${{ secrets.VITE_N8N_WEBHOOK_URL }}" \
              "${{ secrets.VITE_SUPABASE_URL }}" \
              "${{ secrets.VITE_SUPABASE_ANON_KEY }}" \
              "${{ secrets.DOMAIN_NAME }}" \
              "${{ secrets.SUBDOMAIN }}" \
              "${{ secrets.CHICHA_SUBDOMAIN }}" > .env
            
            # Verify required variables are not empty (to avoid Traefik routing issues)
            if [ -z "${{ secrets.DOMAIN_NAME }}" ]; then
              echo "ERROR: DOMAIN_NAME secret is missing. Traefik routing will fail."
              exit 1
            fi

            echo ".env generated successfully."

            # Robust Dependency Sync (Host-side)
            if [ -f package.json ]; then
              echo "Ensuring host dependencies are in sync..."
              # Detect if package.json has changed in the last update
              PACKAGE_CHANGED=$(git diff --name-only HEAD@{1} HEAD | grep "package.json" || true)
              
              if [ -n "$PACKAGE_CHANGED" ] || [ ! -d "node_modules" ]; then
                echo "Package change detected or node_modules missing. Starting install..."
                if ! npm install --no-audit --no-fund; then
                  echo "npm install failed. Attempting clean install (mimicking manual fix)..."
                  rm -rf node_modules package-lock.json
                  npm install --no-audit --no-fund
                fi
              else
                echo "No package changes detected. Skipping host npm install for speed."
              fi
            fi

            echo "Building and restarting Docker containers..."
            docker compose -f docker-compose.yml up -d --build static-website
            docker compose -f docker-compose.yml up -d chicha-website

            # Clean up old images to save space
            docker image prune -f

            echo "Deployment completed successfully at $(date)"
