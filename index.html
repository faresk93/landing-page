<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fares KHIARY</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üë®‚Äçüíª</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            touch-action: none;
        }

        /* UI Animations */
        .fade-out {
            opacity: 0;
            pointer-events: none;
            transform: scale(0.95);
            filter: blur(10px);
        }

        .ui-transition {
            transition: all 1s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* Construction Banner - Simplified */
        .construction-banner {
            background: rgba(255, 165, 0, 0.15);
            border: 2px solid rgba(255, 165, 0, 0.5);
        }

        .construction-icon,
        .gear-spin {
            display: inline-block;
        }


        #interactive-hint {
            opacity: 0;
            transition: opacity 1s;
        }

        .show-hint {
            opacity: 1 !important;
        }

        /* Glitch Text Effect */
        .glitch {
            position: relative;
            color: white;
            text-shadow: 0 0 20px rgba(0, 255, 255, 0.4), 0 0 40px rgba(168, 85, 247, 0.2);
        }

        .glitch#fares {
            margin: 20px 0;
        }

        .glitch::before,
        .glitch::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            width: 100%;
            height: 100%;
            opacity: 0.8;
        }

        .glitch::before {
            left: 2px;
            color: #0ff;
            clip-path: polygon(0 0, 100% 0, 100% 45%, 0 45%);
            animation: glitch-anim-1 4s infinite linear alternate-reverse;
        }

        .glitch::after {
            left: -2px;
            color: #f0f;
            clip-path: polygon(0 55%, 100% 55%, 100% 100%, 0 100%);
            animation: glitch-anim-2 4.5s infinite linear alternate-reverse;
        }

        @keyframes glitch-anim-1 {
            0% {
                transform: translate(0);
            }

            20% {
                transform: translate(-2px, 2px);
            }

            100% {
                transform: translate(1px, -1px);
            }
        }

        @keyframes glitch-anim-2 {
            0% {
                transform: translate(0);
            }

            20% {
                transform: translate(2px, -2px);
            }

            100% {
                transform: translate(-1px, 1px);
            }
        }

        /* Greeting Word Animations */
        .greeting-word {
            opacity: 0;
            position: absolute;
            font-size: 1rem;
            font-weight: 700;
            background: linear-gradient(45deg, #00f5ff, #a855f7, #ec4899, #fbbf24);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: greeting-zoom 8s ease-in-out infinite;
        }

        .greeting-word:nth-child(1) {
            animation-delay: 0s;
        }

        .greeting-word:nth-child(2) {
            animation-delay: 2s;
        }

        .greeting-word:nth-child(3) {
            animation-delay: 4s;
        }

        .greeting-word:nth-child(4) {
            animation-delay: 6s;
        }

        @keyframes greeting-zoom {
            0% {
                opacity: 0;
                transform: scale(0.5);
            }

            10% {
                opacity: 1;
                transform: scale(1.1);
            }

            20% {
                transform: scale(1);
            }

            40% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0;
                transform: scale(0.8);
            }

            100% {
                opacity: 0;
                transform: scale(0.5);
            }
        }

        /* Tech Badge - Simple */
        .tech-badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            background: rgba(34, 211, 238, 0.15);
            border: 1px solid rgba(34, 211, 238, 0.4);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            color: #22d3ee;
        }

        /* Typing Animation */
        .typing-container {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: linear-gradient(135deg, rgba(34, 211, 238, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%);
            border: 1px solid rgba(34, 211, 238, 0.3);
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
        }

        .typing-text {
            font-family: 'Orbitron', monospace;
            font-size: 0.875rem;
            font-weight: 700;
            color: #00d9ff;
        }

        /* Tech Stack Typing & Glitch */
        .tech-typing {
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            color: #22d3ee;
            position: relative;
            display: inline-block;
            text-shadow: 0 0 5px rgba(34, 211, 238, 0.5);
        }

        .tech-typing.glitched {
            animation: stack-glitch 0.2s cubic-bezier(.25, .46, .45, .94) both infinite;
            text-shadow: 2px 0 #ff00c1, -2px 0 #00fff9;
        }

        @keyframes stack-glitch {
            0% {
                transform: translate(0)
            }

            20% {
                transform: translate(-2px, 2px)
            }

            40% {
                transform: translate(-2px, -2px)
            }

            60% {
                transform: translate(2px, 2px)
            }

            80% {
                transform: translate(2px, -2px)
            }

            100% {
                transform: translate(0)
            }
        }

        .cursor-blink {
            animation: blink 0.8s step-end infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }

        /* Info Chip - Simplified */
        .info-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.8rem;
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 9999px;
            font-size: 0.75rem;
            white-space: nowrap;
        }

        .info-chip i {
            font-size: 0.85rem;
            color: #00d9ff;
        }

        /* Social Media Buttons - Simplified */
        .social-btn {
            transition: all 0.2s ease;
        }

        .social-btn:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }

        /* Email Chip - Simplified */
        .email-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(236, 72, 153, 0.15);
            border: 1px solid rgba(236, 72, 153, 0.4);
            border-radius: 9999px;
            transition: all 0.2s ease;
        }

        .email-chip:hover {
            transform: scale(1.02);
            opacity: 0.9;
        }

        .email-chip i {
            color: #ec4899;
        }



        /* Enter Universe Button - Simplified */
        .universe-btn {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.3), rgba(236, 72, 153, 0.3));
            border: 2px solid rgba(249, 115, 22, 0.7);
            transition: all 0.2s ease;
        }

        .universe-btn:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }

        /* Mute Button - Simplified */
        .mute-btn {
            transition: all 0.2s ease;
        }

        .mute-btn:hover {
            opacity: 0.8;
        }

        .mute-btn.muted {
            opacity: 0.5;
        }

        /* Back Button - Simplified */
        .back-btn {
            transition: all 0.2s ease;
        }

        .back-btn:hover {
            opacity: 0.8;
        }


        /* Mobile Optimizations */
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem !important;
            }

            .greeting-word {
                font-size: 0.9rem !important;
            }

            .typing-text {
                font-size: 0.75rem !important;
            }

            .typing-container {
                padding: 0.4rem 0.8rem !important;
            }

            .info-chip {
                font-size: 0.7rem !important;
                padding: 0.3rem 0.6rem !important;
            }

            .social-btn {
                padding: 0.6rem !important;
                font-size: 0.7rem !important;
            }

            .social-btn span {
                display: none;
            }

            .construction-banner {
                padding: 0.5rem !important;
                font-size: 0.75rem !important;
            }

            body {
                overflow-y: auto;
            }

            main {
                min-height: 100vh;
            }
        }

        /* Question Input Styling */
        .question-input-container {
            position: relative;
            max-width: 400px;
            margin: 1.5rem auto 0;
            z-index: 20;
        }

        .question-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 12px;
            padding: 12px 45px 12px 15px;
            color: #fff;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
            outline: none;
        }

        .question-input:focus {
            border-color: rgba(0, 217, 255, 0.8);
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.2);
            background: rgba(0, 0, 0, 0.8);
        }

        .send-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #00d9ff;
            cursor: pointer;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease;
        }

        .send-btn:hover {
            transform: translateY(-50%) scale(1.1);
            color: #fff;
        }

        /* Loading Spinner */
        .loader-container {
            display: none;
            align-items: center;
            gap: 8px;
            position: absolute;
            right: -130px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 12px;
            border-radius: 20px;
            border: 1px solid rgba(0, 217, 255, 0.2);
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.8rem;
            color: #00d9ff;
            white-space: nowrap;
        }

        .gpt-loader {
            width: 14px;
            height: 14px;
            border: 2px solid rgba(0, 217, 255, 0.1);
            border-top: 2px solid #00d9ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Space Popup Styling */
        #space-popup {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 100;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .popup-content {
            background: linear-gradient(135deg, #0b0b1a 0%, #1a1a3a 100%);
            border: 2px solid #4a90e2;
            border-radius: 20px;
            max-width: 500px;
            width: 100%;
            position: relative;
            padding: 35px 25px 25px;
            box-shadow: 0 0 50px rgba(74, 144, 226, 0.3), inset 0 0 20px rgba(74, 144, 226, 0.2);
            animation: popup-glow 4s infinite alternate;
            color: #e0e0e0;
            font-family: 'Rajdhani', sans-serif;
            overflow: hidden;
        }

        @keyframes popup-glow {
            from {
                box-shadow: 0 0 30px rgba(74, 144, 226, 0.2);
            }

            to {
                box-shadow: 0 0 50px rgba(168, 85, 247, 0.4);
            }
        }

        .popup-content::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.05) 0%, transparent 70%);
            pointer-events: none;
        }

        .close-popup {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            color: #fff;
            cursor: pointer;
            transition: transform 0.2s ease;
            z-index: 10;
        }

        .close-popup:hover {
            transform: scale(1.1) rotate(90deg);
            color: #ff4d4d;
        }

        .popup-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            color: #00d9ff;
            margin-bottom: 15px;
            text-align: center;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .popup-body {
            line-height: 1.6;
            font-size: 1.05rem;
            max-height: 60vh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #00d9ff rgba(0, 0, 0, 0.3);
        }

        .popup-body::-webkit-scrollbar {
            width: 6px;
        }

        .popup-body::-webkit-scrollbar-thumb {
            background-color: #00d9ff;
            border-radius: 10px;
        }

        .typing-cursor::after {
            content: '|';
            animation: cursor-blink 0.8s infinite;
            color: #00d9ff;
            margin-left: 2px;
        }

        .hide {
            display: none;
        }

        #popup-question {
            margin-bottom: 20px;
            font-size: .9rem;
        }

        #popup-question #question-wrapper {
            border-bottom: 1px solid;
            border-image: linear-gradient(to right, #aaa, transparent) 1;
            padding-right: 10px;
            font-weight: normal;
        }

        #popup-question #question-wrapper>span {
            font-weight: bold;
        }

        @keyframes cursor-blink {

            0%,
            100% {
                opacity: 0;
            }

            50% {
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .loader-container {
                position: relative;
                right: 0;
                top: 0;
                transform: none;
                margin-top: 10px;
                justify-content: center;
            }
        }
    </style>
</head>

<body class="antialiased text-white selection:bg-cyan-500 selection:text-black">

    <div id="canvas-container" class="absolute inset-0 z-0 bg-black cursor-move"></div>

    <main id="ui-layer"
        class="ui-transition relative z-10 flex flex-col items-center justify-center h-screen w-full px-2 pointer-events-none overflow-hidden">

        <div
            class="pointer-events-auto bg-black/90 border border-white/10 p-3 md:p-4 rounded-lg max-w-4xl w-full shadow-2xl relative">

            <!-- Construction Banner with v1.7 -->
            <div class="construction-banner rounded px-3 py-1.5 md:py-1.5 mb-2 md:mb-1">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="construction-icon text-base">üöß</span>
                        <span class="gear-spin text-base">‚öôÔ∏è</span>
                        <p class="font-['Rajdhani'] text-orange-300 text-xs font-bold tracking-wider uppercase">
                            Work in Progress
                        </p>
                    </div>
                    <div class="font-['Orbitron'] text-orange-400 text-xs font-bold">v2.3</div>
                </div>
            </div>

            <div class="space-y-3">

                <!-- Name -->
                <h1 id="fares"
                    class="glitch text-4xl md:text-6xl font-black tracking-tighter font-['Orbitron'] text-center"
                    data-text="FARES KHIARY">
                    FARES KHIARY
                </h1>

                <!-- Question Input -->
                <div class="question-input-container pointer-events-auto">
                    <input type="text" id="user-question" class="question-input" placeholder="Ask Fares anything..."
                        autocomplete="off">
                    <button id="submit-question" class="send-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                    <div id="loader-container" class="loader-container">
                        <div class="gpt-loader"></div>
                        <span>Thinking... üß†</span>
                    </div>
                </div>

                <!-- Greetings -->
                <div class="relative h-12 md:h-14 flex items-center justify-center">
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span class="greeting-word">Bonjour</span>
                        <span class="greeting-word">ŸÖÿ±ÿ≠ÿ®ÿß</span>
                        <span class="greeting-word">Hello</span>
                        <span class="greeting-word">Hallo</span>
                    </div>
                </div>

                <!-- Tech Stacks - Typing Animation -->
                <div class="flex justify-center mb-2">
                    <div class="typing-container">
                        <i class="fas fa-code text-cyan-400 text-sm"></i>
                        <div class="typing-text">
                            <span>Web Developer ‚Ä¢ </span>
                            <span id="tech-typed" class="tech-typing"></span>
                            <span class="cursor-blink">|</span>
                        </div>
                    </div>
                </div>

                <!-- Personal Info - Inline Chips -->
                <div class="flex flex-wrap items-center justify-center gap-1 mb-1">
                    <div class="info-chip">
                        <i class="fas fa-birthday-cake"></i>
                        <span class="font-['Rajdhani'] font-semibold">32</span>
                    </div>
                    <div class="info-chip">
                        <i class="fas fa-map-marker-alt"></i>
                        <span class="font-['Rajdhani'] font-semibold">Paris üá´üá∑</span>
                    </div>
                    <div class="info-chip">
                        <i class="fas fa-home"></i>
                        <span class="font-['Rajdhani'] font-semibold">üá¥üá≤ Oman</span>
                    </div>
                    <div class="info-chip">
                        <i class="fas fa-flag"></i>
                        <span class="font-['Rajdhani'] font-semibold">üáπüá≥ Tunisia</span>
                    </div>
                </div>

                <!-- Email -->
                <div class="flex justify-center">
                    <a href="mailto:contact@fares-khiary.com" class="email-chip">
                        <i class="fas fa-envelope text-xs"></i>
                        <span
                            class="font-['Rajdhani'] font-semibold text-sm text-pink-200">contact@fares-khiary.com</span>
                    </a>
                </div>

                <!-- Social Media Section -->
                <div class="flex gap-3 justify-center">
                    <a href="https://www.linkedin.com/in/fares-khiary" target="_blank" rel="noopener noreferrer"
                        class="social-btn linkedin flex items-center justify-center gap-1.5 px-3 py-2 bg-gradient-to-r from-blue-900/40 to-blue-700/40 border border-blue-500/50 rounded-lg cursor-pointer group">
                        <i class="fab fa-linkedin text-lg"></i>
                        <span class="font-['Rajdhani'] text-xs font-bold">LinkedIn</span>
                    </a>

                    <a href="https://www.instagram.com/khiary.fares" target="_blank" rel="noopener noreferrer"
                        class="social-btn instagram flex items-center justify-center gap-1.5 px-3 py-2 bg-gradient-to-r from-pink-900/40 to-purple-900/40 border border-pink-500/50 rounded-lg cursor-pointer group">
                        <i class="fab fa-instagram text-lg"></i>
                        <span class="font-['Rajdhani'] text-xs font-bold">Instagram</span>
                    </a>

                    <a href="https://github.com/faresk93" target="_blank" rel="noopener noreferrer"
                        class="social-btn github flex items-center justify-center gap-1.5 px-3 py-2 bg-gradient-to-r from-gray-900/40 to-gray-700/40 border border-gray-500/50 rounded-lg cursor-pointer group">
                        <i class="fab fa-github text-lg"></i>
                        <span class="font-['Rajdhani'] text-xs font-bold">GitHub</span>
                    </a>
                </div>

                <!-- Divider -->
                <div class="border-t border-white/10"></div>

                <!-- Centered Buttons Container -->
                <div class="flex flex-col items-center gap-3">
                    <!-- Enter My Universe Button -->
                    <button id="start-btn"
                        class="universe-btn relative flex items-center justify-center px-6 py-4 font-bold text-white cursor-pointer group uppercase font-['Orbitron'] text-base tracking-widest rounded-lg w-full max-w-lg shadow-[0_0_20px_rgba(249,115,22,0.3)] hover:shadow-[0_0_30px_rgba(249,115,22,0.5)]">
                        <span class="relative z-10 mr-3 text-2xl">üåå</span>
                        <span class="relative z-10">Enter My Universe</span>
                        <svg class="relative z-10 w-5 h-5 ml-3 transition-transform group-hover:translate-x-1"
                            fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 7l5 5m0 0l-5 5m5-5H6" />
                        </svg>
                    </button>
                </div>

                <!-- Footer -->
                <div class="mt-4 pt-3 border-t border-white/10 text-center">
                    <p class="font-['Rajdhani'] text-gray-400 text-xs">
                        Made with <span class="text-red-400">‚ù§Ô∏è</span> by <span class="text-cyan-400 font-bold">Fares
                            KHIARY</span>
                    </p>
                    <p class="font-['Rajdhani'] text-gray-500 text-[10px] mt-1">
                        <span class="text-purple-400">‚ú®</span> Enhanced with AI assistance
                    </p>
                </div>
            </div>
        </div>
    </main>

    <!-- Top Controls -->
    <div class="fixed top-1.5 left-2 z-30 flex items-center gap-3 pointer-events-auto">
        <!-- Mute Button Group -->
        <div
            class="flex items-center gap-2 bg-black/60 backdrop-blur-md rounded-full pr-3 border border-white/10 hover:border-white/20 transition-all h-9">
            <button id="mute-btn"
                class="mute-btn w-9 h-9 rounded-full flex items-center justify-center cursor-pointer hover:bg-white/5 transition-all">
                <svg class="w-4 h-4" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="50" cy="50" r="45" fill="url(#blackhole-gradient)" />
                    <circle cx="50" cy="50" r="15" fill="#000000" />
                    <circle cx="50" cy="50" r="25" fill="none" stroke="#9333EA" stroke-width="2" opacity="0.6" />
                    <circle cx="50" cy="50" r="35" fill="none" stroke="#A855F7" stroke-width="1.5" opacity="0.4" />
                    <defs>
                        <radialGradient id="blackhole-gradient">
                            <stop offset="0%" stop-color="#000000" />
                            <stop offset="40%" stop-color="#1a1a2e" />
                            <stop offset="70%" stop-color="#6B21A8" />
                            <stop offset="100%" stop-color="#C084FC" />
                        </radialGradient>
                    </defs>
                </svg>
            </button>
            <span id="sound-status"
                class="font-['Rajdhani'] text-[10px] font-bold tracking-widest text-cyan-400/80 uppercase whitespace-nowrap">Sound:
                On</span>
        </div>

        <!-- Back Button -->
        <button id="back-btn"
            class="back-btn hidden px-3 py-1.5 rounded-lg bg-black/80 border border-white/20 flex items-center gap-1.5 cursor-pointer hover:bg-black/90 font-['Orbitron'] text-[10px] font-bold tracking-wider h-9">
            <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            <span>BACK</span>
        </button>
    </div>

    <div id="interactive-hint" class="fixed bottom-4 w-full text-center pointer-events-none z-20">
        <p
            class="font-['Rajdhani'] text-cyan-300 text-xs tracking-[0.2em] uppercase drop-shadow-md bg-black/50 inline-block px-3 py-1 rounded-full border border-cyan-500/30">
            üñ±Ô∏è Drag ‚Ä¢ Scroll ‚Ä¢ Explore
        </p>
    </div>

    <!-- Space Response Popup -->
    <div id="space-popup">
        <div class="popup-content">
            <span id="close-popup" class="close-popup">&times;</span>
            <div class="popup-title">Frequency Received</div>
            <div id="popup-question" class="popup-body hide">
                <span id="question-wrapper">
                    <span>Question:</span>
                </span>
            </div>
            <div id="popup-text" class="popup-body">
                Connecting to deep space network...
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';

        // --- SETUP ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.0012);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 2000);

        // Mobile optimization: adjust camera Z pos to see more of the universe
        const isMobile = window.innerWidth < 768;
        camera.position.set(0, isMobile ? 10 : 20, isMobile ? 140 : 100);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // --- TEXTURE GENERATOR ---
        const createTexture = (type) => {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');

            if (type === 'sun') {
                const grd = ctx.createRadialGradient(256, 256, 0, 256, 256, 256);
                grd.addColorStop(0, "#ffffff");
                grd.addColorStop(0.2, "#fffacd");
                grd.addColorStop(0.4, "#ffff00");
                grd.addColorStop(0.6, "#ffaa00");
                grd.addColorStop(0.8, "#ff8800");
                grd.addColorStop(1, "#ff4400");
                ctx.fillStyle = grd; ctx.fillRect(0, 0, 512, 512);

                // Add "Web" text to sun
                ctx.fillStyle = "#ffffff";
                ctx.font = "bold 120px Arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.shadowColor = "#000000";
                ctx.shadowBlur = 10;
                ctx.fillText("Web", 256, 256);
            } else if (type === 'planet') {
                const grd = ctx.createRadialGradient(256, 256, 150, 256, 256, 300);
                grd.addColorStop(0, "rgba(255,255,255,0.4)");
                grd.addColorStop(1, "rgba(0,0,0,0.6)");
                ctx.fillStyle = grd; ctx.fillRect(0, 0, 512, 512);

                for (let i = 0; i < 120; i++) {
                    ctx.fillStyle = `rgba(${100 + Math.random() * 155}, ${100 + Math.random() * 155}, ${100 + Math.random() * 155}, 0.2)`;
                    ctx.beginPath();
                    ctx.arc(Math.random() * 512, Math.random() * 512, Math.random() * 50, 0, Math.PI * 2);
                    ctx.fill();
                }
            } else if (type === 'particle') {
                const grd = ctx.createRadialGradient(256, 256, 0, 256, 256, 256);
                grd.addColorStop(0, "rgba(255,255,255,1)");
                grd.addColorStop(0.5, "rgba(255,255,200,0.5)");
                grd.addColorStop(1, "rgba(0,0,0,0)");
                ctx.fillStyle = grd; ctx.fillRect(0, 0, 512, 512);
            }
            return new THREE.CanvasTexture(canvas);
        };

        // Create planet textures with tech labels
        const createPlanetTexture = (label, color) => {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');

            // Planet surface
            const grd = ctx.createRadialGradient(256, 256, 150, 256, 256, 300);
            grd.addColorStop(0, `rgba(${color[0]},${color[1]},${color[2]},0.5)`);
            grd.addColorStop(1, "rgba(0,0,0,0.7)");
            ctx.fillStyle = grd; ctx.fillRect(0, 0, 512, 512);

            // Surface details
            for (let i = 0; i < 100; i++) {
                ctx.fillStyle = `rgba(${color[0] + Math.random() * 50}, ${color[1] + Math.random() * 50}, ${color[2] + Math.random() * 50}, 0.2)`;
                ctx.beginPath();
                ctx.arc(Math.random() * 512, Math.random() * 512, Math.random() * 40, 0, Math.PI * 2);
                ctx.fill();
            }

            return new THREE.CanvasTexture(canvas);
        };

        // Create sprite label for planets
        const createSpriteLabel = (text, color) => {
            const canvas = document.createElement('canvas');
            canvas.width = 256;
            canvas.height = 128;
            const ctx = canvas.getContext('2d');

            // Background with rounded rectangle
            ctx.fillStyle = `rgba(0, 0, 0, 0.7)`;
            ctx.beginPath();
            ctx.roundRect(10, 30, 236, 68, 15);
            ctx.fill();

            // Border with color
            ctx.strokeStyle = `rgba(${color[0]}, ${color[1]}, ${color[2]}, 0.8)`;
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.roundRect(10, 30, 236, 68, 15);
            ctx.stroke();

            // Text
            ctx.fillStyle = "#ffffff";
            ctx.font = "bold 42px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.shadowColor = `rgba(${color[0]}, ${color[1]}, ${color[2]}, 0.9)`;
            ctx.shadowBlur = 15;
            ctx.fillText(text, 128, 64);

            const texture = new THREE.CanvasTexture(canvas);
            const spriteMaterial = new THREE.SpriteMaterial({
                map: texture,
                transparent: true,
                opacity: 0.95
            });
            const sprite = new THREE.Sprite(spriteMaterial);
            sprite.scale.set(8, 4, 1);

            return sprite;
        };

        // --- SOLAR SYSTEM ---
        const solarSystem = new THREE.Group();
        scene.add(solarSystem);

        // Enhanced Sun with "Web" label
        const sunGeo = new THREE.SphereGeometry(12, 64, 64);
        const sunMat = new THREE.MeshBasicMaterial({
            map: createTexture('sun'),
            emissive: 0xffaa00,
            emissiveIntensity: 0.9
        });
        const sun = new THREE.Mesh(sunGeo, sunMat);
        solarSystem.add(sun);

        // Multi-layered Sun Glow
        for (let i = 0; i < 3; i++) {
            const glowMat = new THREE.SpriteMaterial({
                map: createTexture('particle'),
                color: i === 0 ? 0xffff00 : (i === 1 ? 0xffaa00 : 0xff6600),
                transparent: true,
                opacity: 0.7 - (i * 0.15),
                blending: THREE.AdditiveBlending
            });
            const glow = new THREE.Sprite(glowMat);
            glow.scale.set(75 + (i * 25), 75 + (i * 25), 1);
            solarSystem.add(glow);
        }

        // Enhanced Lighting
        const pointLight = new THREE.PointLight(0xffffdd, 5, 550);
        solarSystem.add(pointLight);
        scene.add(new THREE.AmbientLight(0x606060));

        // Planets with tech labels
        const planets = [];
        const techLabels = ['JS', 'PHP', 'DB', 'AI', 'React', 'Node', 'AWS', 'Docker'];
        const planetColors = [
            [220, 180, 100],  // JS - golden
            [100, 100, 220],  // PHP - purple
            [50, 150, 220],   // DB - blue
            [220, 50, 150],   // AI - magenta
            [100, 220, 250],  // React - cyan
            [100, 200, 100],  // Node - green
            [255, 153, 0],    // AWS - orange
            [100, 180, 220]   // Docker - blue
        ];

        const createPlanet = (size, dist, speed, label, color) => {
            const mesh = new THREE.Mesh(
                new THREE.SphereGeometry(size, 32, 32),
                new THREE.MeshStandardMaterial({
                    map: createPlanetTexture(label, color),
                    roughness: 0.4,
                    metalness: 0.4,
                    emissive: new THREE.Color(color[0] / 255, color[1] / 255, color[2] / 255),
                    emissiveIntensity: 0.3
                })
            );
            const angle = Math.random() * Math.PI * 2;
            mesh.position.set(Math.cos(angle) * dist, 0, Math.sin(angle) * dist);

            // Enhanced orbit rings
            const ringGeo = new THREE.RingGeometry(dist - 0.3, dist + 0.3, 128);
            const ringMat = new THREE.MeshBasicMaterial({
                color: new THREE.Color(color[0] / 255, color[1] / 255, color[2] / 255),
                side: THREE.DoubleSide,
                transparent: true,
                opacity: 0.2
            });
            const ring = new THREE.Mesh(ringGeo, ringMat);
            ring.rotation.x = Math.PI / 2;
            solarSystem.add(ring);

            // Add sprite label
            const spriteLabel = createSpriteLabel(label, color);
            spriteLabel.position.copy(mesh.position);
            spriteLabel.position.y += size + 3;
            solarSystem.add(spriteLabel);

            solarSystem.add(mesh);
            return { mesh, dist, speed, angle, label: spriteLabel, size };
        };

        // Create planets with tech labels
        const distances = [25, 35, 45, 55, 75, 95, 115, 130];
        const speeds = [0.8, 0.6, 0.5, 0.4, 0.2, 0.15, 0.1, 0.08];
        const sizes = [1.5, 2.5, 2.8, 2, 6, 5, 3.5, 3.5];

        for (let i = 0; i < 8; i++) {
            planets.push(createPlanet(sizes[i], distances[i], speeds[i], techLabels[i], planetColors[i]));
        }

        // Asteroid Belt
        const asteroidGeo = new THREE.TetrahedronGeometry(0.5, 0);
        const asteroidMat = new THREE.MeshStandardMaterial({
            color: 0xaaaaaa,
            roughness: 0.9,
            metalness: 0.1,
            emissive: 0x444444,
            emissiveIntensity: 0.15
        });
        const asteroids = new THREE.InstancedMesh(asteroidGeo, asteroidMat, 2000);
        const dummy = new THREE.Object3D();

        for (let i = 0; i < 2000; i++) {
            const r = 60 + Math.random() * 20;
            const theta = Math.random() * Math.PI * 2;
            const y = (Math.random() - 0.5) * 12;

            dummy.position.set(r * Math.cos(theta), y, r * Math.sin(theta));
            dummy.rotation.set(Math.random(), Math.random(), Math.random());
            dummy.scale.setScalar(Math.random() * 2.5);
            dummy.updateMatrix();
            asteroids.setMatrixAt(i, dummy.matrix);
        }
        solarSystem.add(asteroids);

        // Enhanced Starfield
        const starsGeo = new THREE.BufferGeometry();
        const starsPos = [];
        const starsColors = [];
        const starsSizes = [];

        for (let i = 0; i < 10000; i++) {
            starsPos.push(
                (Math.random() - 0.5) * 2000,
                (Math.random() - 0.5) * 2000,
                (Math.random() - 0.5) * 2000
            );

            const colorChoice = Math.random();
            if (colorChoice > 0.8) {
                starsColors.push(0.6 + Math.random() * 0.4, 0.7 + Math.random() * 0.3, 1.0);
            } else if (colorChoice > 0.5) {
                starsColors.push(1.0, 1.0, 1.0);
            } else if (colorChoice > 0.2) {
                starsColors.push(1.0, 0.9 + Math.random() * 0.1, 0.7 + Math.random() * 0.2);
            } else {
                starsColors.push(1.0, 0.6 + Math.random() * 0.2, 0.5 + Math.random() * 0.2);
            }

            starsSizes.push(Math.random() * 4 + 0.3);
        }

        starsGeo.setAttribute('position', new THREE.Float32BufferAttribute(starsPos, 3));
        starsGeo.setAttribute('color', new THREE.Float32BufferAttribute(starsColors, 3));
        starsGeo.setAttribute('size', new THREE.Float32BufferAttribute(starsSizes, 1));

        const stars = new THREE.Points(
            starsGeo,
            new THREE.PointsMaterial({
                size: 2.5,
                vertexColors: true,
                transparent: true,
                opacity: 0.95,
                sizeAttenuation: true
            })
        );
        scene.add(stars);

        // Nebula Clouds - Enhanced
        const nebulaGeo = new THREE.SphereGeometry(350, 32, 32);
        const nebulaMat = new THREE.MeshBasicMaterial({
            color: 0x9333ea,
            transparent: true,
            opacity: 0.1,
            side: THREE.BackSide,
            blending: THREE.AdditiveBlending
        });
        const nebula1 = new THREE.Mesh(nebulaGeo, nebulaMat);
        nebula1.position.set(200, 100, -200);
        scene.add(nebula1);

        const nebula2 = new THREE.Mesh(nebulaGeo.clone(), nebulaMat.clone());
        nebula2.material.color.setHex(0x06b6d4);
        nebula2.position.set(-200, -100, 200);
        scene.add(nebula2);

        const nebula3 = new THREE.Mesh(nebulaGeo.clone(), nebulaMat.clone());
        nebula3.material.color.setHex(0xec4899);
        nebula3.position.set(0, 150, 100);
        scene.add(nebula3);

        // --- INTERACTION ---
        let isDragging = false;
        let isPanning = false;
        let previousMousePosition = { x: 0, y: 0 };
        let state = 'MENU';

        let cameraDistance = 150;
        let cameraOffset = { x: 0, y: 30, z: 0 };
        const minDistance = 30;
        const maxDistance = 300;

        const handleStart = (x, y, button = 0, shiftKey = false) => {
            if (button === 2 || shiftKey) {
                isPanning = true;
            } else {
                isDragging = true;
            }
            previousMousePosition = { x, y };
        };

        const handleMove = (x, y) => {
            const deltaMove = {
                x: x - previousMousePosition.x,
                y: y - previousMousePosition.y
            };

            if (isPanning && state === 'UNLOCKED') {
                const panSpeed = 0.3;
                cameraOffset.x -= deltaMove.x * panSpeed;
                cameraOffset.y += deltaMove.y * panSpeed;
            } else if (isDragging && state === 'UNLOCKED') {
                const rotateSpeed = 0.005;
                solarSystem.rotation.y += deltaMove.x * rotateSpeed;
                solarSystem.rotation.x += deltaMove.y * rotateSpeed;
            }

            previousMousePosition = { x, y };
        };

        const handleEnd = () => {
            isDragging = false;
            isPanning = false;
        };

        const handleWheel = (e) => {
            if (state === 'UNLOCKED') {
                e.preventDefault();
                const zoomSpeed = 0.1;
                cameraDistance += e.deltaY * zoomSpeed;
                cameraDistance = Math.max(minDistance, Math.min(maxDistance, cameraDistance));
            }
        };

        document.addEventListener('mousedown', e => handleStart(e.clientX, e.clientY, e.button, e.shiftKey));
        document.addEventListener('touchstart', e => handleStart(e.touches[0].clientX, e.touches[0].clientY), { passive: false });
        document.addEventListener('mousemove', e => handleMove(e.clientX, e.clientY));
        document.addEventListener('touchmove', e => {
            e.preventDefault();
            handleMove(e.touches[0].clientX, e.touches[0].clientY);
        }, { passive: false });
        document.addEventListener('mouseup', handleEnd);
        document.addEventListener('touchend', handleEnd);
        document.addEventListener('wheel', handleWheel, { passive: false });
        document.addEventListener('contextmenu', e => {
            if (state === 'UNLOCKED') e.preventDefault();
        });

        // --- ENHANCED AUDIO WITH SHOOTING STARS & SPACECRAFT ---
        let audioContext;
        let masterGain;
        let oscillators = [];
        let noiseNode = null;
        let isMuted = false;
        let isAudioInitialized = false;

        const muteBtn = document.getElementById('mute-btn');

        const initAudio = async () => {
            if (isAudioInitialized) return;

            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();

                // Ensure audio context is running
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }

                masterGain = audioContext.createGain();
                masterGain.connect(audioContext.destination);
                masterGain.gain.setValueAtTime(0, audioContext.currentTime);
                masterGain.gain.linearRampToValueAtTime(0.15, audioContext.currentTime + 2);

                // Base ambient frequencies
                const frequencies = [55, 73, 110, 147, 220];

                frequencies.forEach((freq, index) => {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();

                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    gain.gain.value = 0.08 / (index + 1);

                    osc.connect(gain);
                    gain.connect(masterGain);
                    osc.start(audioContext.currentTime);
                    oscillators.push({ osc, gain });

                    const lfo = audioContext.createOscillator();
                    lfo.frequency.value = 0.08 + (index * 0.04);
                    const lfoGain = audioContext.createGain();
                    lfoGain.gain.value = 1.5 + (index * 0.3);

                    lfo.connect(lfoGain);
                    lfoGain.connect(osc.frequency);
                    lfo.start(audioContext.currentTime);
                });

                // White noise
                const bufferSize = 4096;
                noiseNode = audioContext.createScriptProcessor(bufferSize, 1, 1);
                noiseNode.onaudioprocess = (e) => {
                    const output = e.outputBuffer.getChannelData(0);
                    for (let i = 0; i < bufferSize; i++) {
                        output[i] = (Math.random() * 2 - 1) * 0.015;
                    }
                };

                const noiseFilter = audioContext.createBiquadFilter();
                noiseFilter.type = 'lowpass';
                noiseFilter.frequency.value = 350;

                noiseNode.connect(noiseFilter);
                noiseFilter.connect(masterGain);

                // Shooting star sound effect (periodic high-pitched sweep)
                setInterval(() => {
                    if (!isMuted && audioContext && audioContext.state === 'running') {
                        try {
                            const shootingStar = audioContext.createOscillator();
                            const shootingGain = audioContext.createGain();

                            shootingStar.type = 'sine';
                            shootingStar.frequency.setValueAtTime(1200, audioContext.currentTime);
                            shootingStar.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.5);

                            shootingGain.gain.setValueAtTime(0, audioContext.currentTime);
                            shootingGain.gain.linearRampToValueAtTime(0.03, audioContext.currentTime + 0.05);
                            shootingGain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);

                            shootingStar.connect(shootingGain);
                            shootingGain.connect(masterGain);
                            shootingStar.start(audioContext.currentTime);
                            shootingStar.stop(audioContext.currentTime + 0.5);
                        } catch (e) {
                            console.warn('Shooting star sound failed:', e);
                        }
                    }
                }, 8000 + Math.random() * 4000); // Random interval between 8-12 seconds

                // Spacecraft whoosh sound (periodic)
                setInterval(() => {
                    if (!isMuted && audioContext && audioContext.state === 'running') {
                        try {
                            const spacecraft = audioContext.createOscillator();
                            const spacecraftGain = audioContext.createGain();
                            const spacecraftFilter = audioContext.createBiquadFilter();

                            spacecraft.type = 'sawtooth';
                            spacecraft.frequency.setValueAtTime(80, audioContext.currentTime);
                            spacecraft.frequency.linearRampToValueAtTime(120, audioContext.currentTime + 1.5);

                            spacecraftFilter.type = 'lowpass';
                            spacecraftFilter.frequency.setValueAtTime(400, audioContext.currentTime);
                            spacecraftFilter.frequency.linearRampToValueAtTime(800, audioContext.currentTime + 1.5);

                            spacecraftGain.gain.setValueAtTime(0, audioContext.currentTime);
                            spacecraftGain.gain.linearRampToValueAtTime(0.02, audioContext.currentTime + 0.3);
                            spacecraftGain.gain.linearRampToValueAtTime(0.02, audioContext.currentTime + 1.2);
                            spacecraftGain.gain.linearRampToValueAtTime(0, audioContext.currentTime + 1.5);

                            spacecraft.connect(spacecraftFilter);
                            spacecraftFilter.connect(spacecraftGain);
                            spacecraftGain.connect(masterGain);
                            spacecraft.start(audioContext.currentTime);
                            spacecraft.stop(audioContext.currentTime + 1.5);
                        } catch (e) {
                            console.warn('Spacecraft sound failed:', e);
                        }
                    }
                }, 15000 + Math.random() * 10000); // Random interval between 15-25 seconds

                isAudioInitialized = true;
                console.log('‚úÖ Audio initialized with space effects. State:', audioContext.state);

                // Force resume if still suspended
                if (audioContext.state !== 'running') {
                    await audioContext.resume();
                    console.log('üîä Audio context resumed. New state:', audioContext.state);
                }
            } catch (error) {
                console.error('‚ùå Audio initialization failed:', error);
            }
        };

        muteBtn.addEventListener('click', async () => {
            if (!isAudioInitialized) {
                await initAudio();
            }

            if (audioContext && audioContext.state === 'suspended') {
                await audioContext.resume();
            }

            isMuted = !isMuted;
            if (audioContext && masterGain) {
                masterGain.gain.setValueAtTime(masterGain.gain.value, audioContext.currentTime);
                masterGain.gain.linearRampToValueAtTime(isMuted ? 0 : 0.15, audioContext.currentTime + 0.5);
            }
            muteBtn.classList.toggle('muted', isMuted);

            // Update sound status text
            const soundStatus = document.getElementById('sound-status');
            if (soundStatus) {
                soundStatus.innerText = isMuted ? 'Sound: Off' : 'Sound: On';
                soundStatus.classList.toggle('text-gray-500', isMuted);
                soundStatus.classList.toggle('text-cyan-400/80', !isMuted);
            }
        });

        const startAudio = async () => {
            if (!isAudioInitialized && !isMuted) {
                await initAudio();
            }
            if (audioContext && audioContext.state === 'suspended') {
                await audioContext.resume();
            }
        };



        document.getElementById('start-btn').addEventListener('click', () => {
            state = 'UNLOCKED';
            document.getElementById('ui-layer').classList.add('fade-out');
            document.getElementById('interactive-hint').classList.add('show-hint');
            document.getElementById('back-btn').classList.remove('hidden');
            document.getElementById('back-btn').classList.add('flex');
            startAudio();
        });

        document.getElementById('back-btn').addEventListener('click', () => {
            state = 'MENU';
            document.getElementById('ui-layer').classList.remove('fade-out');
            document.getElementById('interactive-hint').classList.remove('show-hint');
            document.getElementById('back-btn').classList.add('hidden');
            document.getElementById('back-btn').classList.remove('flex');
            cameraDistance = 150;
            cameraOffset = { x: 0, y: 30, z: 0 };
            solarSystem.rotation.set(0, 0, 0);
        });

        // Auto-start audio on first user interaction
        const autoStartAudio = async () => {
            console.log('üéµ User interaction detected, starting audio...');
            await startAudio();
            // Remove listeners after first successful init
            if (isAudioInitialized) {
                ['click', 'touchstart', 'keydown'].forEach(event => {
                    document.removeEventListener(event, autoStartAudio);
                });
            }
        };

        const events = ['click', 'touchstart', 'keydown'];
        events.forEach(event => {
            document.addEventListener(event, autoStartAudio, { once: true });
        });

        // --- TYPING & GLITCH ANIMATION ---
        const techWords = [
            "JavaScript", "PHP", "React", "Node.js", "Docker", "AWS",
            "MySQL", "Python", "TypeScript", "Next.js", "Three.js",
            "Linux", "Git", "DevOps", "Rust", "Go", "Kubernetes",
            "GraphQL", "TailwindCSS", "Svelte"
        ];
        const typedElement = document.getElementById('tech-typed');
        let wordIndex = 0;
        let charIndex = 0;
        let isDeleting = false;

        function typeEffect() {
            if (!typedElement) return;

            const currentWord = techWords[wordIndex];

            if (isDeleting) {
                charIndex--;
                typedElement.textContent = currentWord.substring(0, charIndex);
            } else {
                charIndex++;
                typedElement.textContent = currentWord.substring(0, charIndex);
            }

            // Determine typing speed
            let typeSpeed = isDeleting ? 40 : 100;

            // Random glitch effect while typing
            if (!isDeleting && Math.random() < 0.1) {
                typedElement.classList.add('glitched');
                setTimeout(() => typedElement.classList.remove('glitched'), 150);
            }

            if (!isDeleting && charIndex === currentWord.length) {
                // Word complete
                typeSpeed = 2000;
                isDeleting = true;

                // Final glitch on completion
                typedElement.classList.add('glitched');
                setTimeout(() => typedElement.classList.remove('glitched'), 500);
            } else if (isDeleting && charIndex === 0) {
                // Deletion complete
                isDeleting = false;
                wordIndex = (wordIndex + 1) % techWords.length;
                typeSpeed = 500;
            }

            setTimeout(typeEffect, typeSpeed);
        }

        // Start typing animation
        typeEffect();

        // --- WEBHOOK & POPUP LOGIC ---
        const questionInput = document.getElementById('user-question');
        const submitBtn = document.getElementById('submit-question');
        const loader = document.getElementById('loader-container');
        const popup = document.getElementById('space-popup');
        const popupText = document.getElementById('popup-text');
        const questionText = document.getElementById('popup-question');
        const closePopup = document.getElementById('close-popup');

        // --- PLACEHOLDER ANIMATION ---
        const placeholderPhrases = [
            "Ask Fares anything...",
            "Poser une question √† Fares...",
            "ÿ•ÿ≥ÿ£ŸÑ ŸÅÿßÿ±ÿ≥ ÿ£ŸäŸë ÿ¥Ÿäÿ°..."
        ];
        let placeholderIndex = 0;
        let placeholderCharIndex = 0;
        let isPlaceholderDeleting = false;

        function animatePlaceholder() {
            if (!questionInput) return;

            // Pause animation if user is focused on input or has typed something
            if (document.activeElement === questionInput || questionInput.value !== "") {
                setTimeout(animatePlaceholder, 300);
                return;
            }

            const currentPhrase = placeholderPhrases[placeholderIndex];

            if (isPlaceholderDeleting) {
                placeholderCharIndex--;
            } else {
                placeholderCharIndex++;
            }

            questionInput.placeholder = currentPhrase.substring(0, placeholderCharIndex);

            // Faster speeds: 60ms typing, 30ms deleting
            let typingSpeed = isPlaceholderDeleting ? 10 : 40;

            if (!isPlaceholderDeleting && placeholderCharIndex === currentPhrase.length) {
                typingSpeed = 1000; // Pause at the end for 1.5s
                isPlaceholderDeleting = true;
            } else if (isPlaceholderDeleting && placeholderCharIndex === 0) {
                isPlaceholderDeleting = false;
                placeholderIndex = (placeholderIndex + 1) % placeholderPhrases.length;
                typingSpeed = 300; // Short pause before typing next phrase
            }

            setTimeout(animatePlaceholder, typingSpeed);
        }

        // Start placeholder animation
        animatePlaceholder();

        let typeTimeout;
        const playTypeSound = () => {
            if (!audioContext || isMuted) return;
            try {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(150 + Math.random() * 100, audioContext.currentTime);
                gain.gain.setValueAtTime(0.02, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.05);
                osc.connect(gain);
                gain.connect(masterGain || audioContext.destination);
                osc.start();
                osc.stop(audioContext.currentTime + 0.05);
            } catch (e) { }
        };

        const typeMessage = (text, element, question = '', questionText = null, speed = 30) => {
            let i = 0;
            element.innerText = '';
            element.classList.add('typing-cursor');

            if (questionText) {
                questionText.classList.remove('hide')
                questionText.innerHTML = `<span id="question-wrapper"><span>Question:</span> "${question}"</span>`
            }

            if (typeTimeout) clearTimeout(typeTimeout);

            const internalTyping = () => {
                if (i < text.length) {
                    element.innerText += text.charAt(i);
                    playTypeSound();
                    i++;
                    typeTimeout = setTimeout(internalTyping, speed + Math.random() * 20);
                } else {
                    element.classList.remove('typing-cursor');
                }
            };
            internalTyping();
        };

        const askQuestion = async () => {
            const question = questionInput.value.trim();
            if (!question) return;

            // Blur input to hide keyboard on mobile
            questionInput.blur();

            // Show loader
            loader.style.display = 'flex';
            submitBtn.style.opacity = '0.5';
            submitBtn.disabled = true;

            try {
                const webhookUrl = `https://n8n.fares-khiary.com/webhook/886cf54c-6c18-4ea3-8f3c-c8215751748f?question=${encodeURIComponent(question)}`;
                const response = await fetch(webhookUrl);

                if (!response.ok) throw new Error('Network response was not ok');

                const data = await response.json();
                const message = data.output || data.response || data.message || (typeof data === 'string' ? data : JSON.stringify(data));

                popup.style.display = 'flex';
                typeMessage(message, popupText, question, questionText);
            } catch (error) {
                console.error('Error fetching webhook:', error);
                popup.style.display = 'flex';
                typeMessage("Failed to connect to Fares's mind üß† Please try again later.", popupText);
            } finally {
                loader.style.display = 'none';
                submitBtn.style.opacity = '1';
                submitBtn.disabled = false;
                questionInput.value = '';
            }
        };

        submitBtn.addEventListener('click', askQuestion);
        questionInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') askQuestion();
        });

        // empty question block
        function emptyQuestionBlock() {
            const questionText = document.getElementById('popup-question');
            questionText?.classList.add('hide')
        }

        closePopup.addEventListener('click', () => {
            popup.style.display = 'none';
            if (typeTimeout) clearTimeout(typeTimeout);
            emptyQuestionBlock()
        });

        window.addEventListener('click', (e) => {
            if (e.target === popup) {
                popup.style.display = 'none';
                emptyQuestionBlock();
            }
        });

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);

            // Re-adjust camera on resize
            const isMob = window.innerWidth < 768;
            camera.position.z = isMob ? 140 : 100;
            camera.position.y = isMob ? 10 : 20;
        });

        // --- ANIMATION LOOP ---
        const clock = new THREE.Clock();

        const animate = () => {
            requestAnimationFrame(animate);

            const delta = clock.getDelta();
            const time = clock.getElapsedTime();

            // Rotate Solar System
            solarSystem.rotation.y += 0.001;

            // Orbite des plan√®tes
            planets.forEach(p => {
                p.angle += p.speed * delta;
                p.mesh.position.x = Math.cos(p.angle) * p.dist;
                p.mesh.position.z = Math.sin(p.angle) * p.dist;
                p.mesh.rotation.y += delta * 0.3;

                // Make labels face camera
                if (p.label) {
                    p.label.position.copy(p.mesh.position);
                    p.label.position.y += p.size + 2;
                    // Add slight bobbing to label
                    p.label.position.y += Math.sin(time * 2) * 0.5;
                }
            });

            // Asteroids
            asteroids.rotation.y += 0.015 * delta;

            // Sun pulse
            const pulse = 1 + Math.sin(time * 2) * 0.07;
            if (typeof sun !== 'undefined') sun.scale.setScalar(pulse);

            // Stars
            stars.rotation.y += 0.0001;
            stars.rotation.x += 0.00004;
            const twinkle = 0.85 + Math.sin(time * 0.7) * 0.15;
            stars.material.opacity = twinkle;

            // Nebulas
            nebula1.rotation.y += 0.00012;
            nebula1.rotation.z += 0.00006;
            nebula2.rotation.y -= 0.0001;
            nebula2.rotation.z -= 0.00007;
            nebula3.rotation.y += 0.00008;
            nebula3.rotation.z -= 0.00005;

            // Camera movement
            if (state === 'MENU') {
                const isMob = window.innerWidth < 768;
                const baseZ = isMob ? 140 : 100;
                const baseY = isMob ? 10 : 20;

                camera.position.x = Math.sin(time * 0.15) * 25;
                camera.position.y = baseY + Math.cos(time * 0.15) * 12;
                camera.position.z = baseZ + Math.sin(time * 0.1) * 10;
                camera.lookAt(0, 0, 0);
            } else {
                const targetPos = new THREE.Vector3(
                    cameraOffset.x,
                    cameraOffset.y,
                    cameraDistance
                );
                camera.position.lerp(targetPos, 0.1);
                camera.lookAt(0, 0, 0);
            }

            renderer.render(scene, camera);
        }

        animate();
    </script>
</body>

</html>